
# load required package
```{r}
library(data.table)
library(tidyverse)
library(survminer)
library(survival)
library(ggridges)
library(qvalue)
library(readxl)
library(verification)
library(pROC)
library(scales)
library(RColorBrewer)
```

# Set parameters and directories
```{r}
main_fig_dir = "./Results/"
cols = c("black", "#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A") #brewer.pal(n = 11, name = "Paired")
cols2 = c("black", "#A6CEE3", "#1F78B4", "#33A02C", "#FB9A99", "#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A") #brewer.pal(n = 11, name = "Paired")
aneuploidy_threshold = 0.2
fga_threshold = 0.2
```

# load data (Samstein et al. cohort)
```{r}
sample_data = fread("./tmb_mskcc_2018/data_clinical_sample.txt") %>%
  filter(CANCER_TYPE != "Skin Cancer, Non-Melanoma")
patient_data = fread("./tmb_mskcc_2018/data_clinical_patient.txt")

aneuploidy_df = fread("./output0.1_aneuploidy_scores.txt") %>%
  filter(grepl("MSK", sample)) %>%
  mutate(sample = gsub("GENIE-MSK-", "", sample))

for (AS_temp in seq(0.2,0.2,0.01)){
  AS_df_temp = fread(paste0("./","output",AS_temp,"_aneuploidy_scores.txt")) %>%
  filter(grepl("MSK", sample)) %>%
  mutate(sample = gsub("GENIE-MSK-", "", sample))
  AS_df_temp = AS_df_temp[,2]
  aneuploidy_df = data.frame(c(aneuploidy_df,AS_df_temp))
}
colnames(aneuploidy_df) = c("SAMPLE_ID", paste0("aneuploidy_score", seq(0.1,0.2,0.1)))

mskcc_df0 = left_join(sample_data, patient_data) %>% 
  left_join(aneuploidy_df) %>%
  filter(CANCER_TYPE != "Skin Cancer, Non-Melanoma") %>%
  group_by(CANCER_TYPE) %>%
  mutate(OS_STATUS = as.numeric(substr(OS_STATUS, 1, 1)),
         OS_MONTHS = as.numeric(OS_MONTHS))

segs = fread("genie_data_cna_hg19.seg")
segs2 = segs %>% filter(grepl("MSK", ID)) %>%
  mutate(ID = gsub("GENIE-MSK-", "", ID)) %>%
  filter(ID %in% mskcc_df0$SAMPLE_ID)
segs2 = segs2 %>% mutate(seg_length = loc.end - loc.start)

fga_df = segs2 %>% group_by(ID) %>%
  summarize(FGA = sum(seg_length[abs(seg.mean) >= 0.01]) / sum(seg_length))
for (fga_temp in seq(0.02,0.5,0.01)){
  fga_df_temp = segs2 %>% group_by(ID) %>%
    summarize(FGA = sum(seg_length[abs(seg.mean) >= fga_temp]) / sum(seg_length))
  fga_df_temp = fga_df_temp[,2]
  fga_df = data.frame(c(fga_df,fga_df_temp))
}
colnames(fga_df) = c("ID", paste0("fga", seq(0.01,0.5,0.01)))

mskcc_df0 = left_join(mskcc_df0, fga_df, by = c("SAMPLE_ID" = "ID"))

write.csv(mskcc_df0,file = 'MSK_allInfo.csv',row.names = FALSE)

mskcc_df0 = mskcc_df0 %>% 
    rename("aneuploidy_score" = paste0("aneuploidy_score",aneuploidy_threshold),
           "fga" = paste0("fga",fga_threshold))
    

mskcc_df0 = mskcc_df0 %>% group_by(CANCER_TYPE) %>% mutate(
         aneuploidy_score_bin = ifelse(aneuploidy_score >= quantile(aneuploidy_score, 0.5), "high", "low"),
         fga_bin = ifelse(fga >= quantile(fga, 0.5), "high", "low"),
         tmb_bin = ifelse(TMB_NONSYNONYMOUS >= quantile(TMB_NONSYNONYMOUS, 0.8), "high", "low"),
         tmb_bin_10 = ifelse(TMB_NONSYNONYMOUS >= 10, "high", "low"))

mskcc_df = mskcc_df0[c('CANCER_TYPE', 'TMB_NONSYNONYMOUS', 'AGE_AT_SEQ_REPORT', 'SEX', 'SAMPLE_TYPE', 'OS_MONTHS', 'OS_STATUS', 'DRUG_TYPE', 'aneuploidy_score', 'fga', 'aneuploidy_score_bin', 'fga_bin', 'tmb_bin')]
colnames(mskcc_df) = c('CancerType', 'TMB', 'Age', 'Sex', 'Sample_type', 'OS_Months', 'OS_Event', 'Drug_class', 'AS', 'FGA', 'AS_score', 'FGA_score', 'TMB_score')
mskcc_df$CancerType <- tolower(mskcc_df$CancerType)

capFirst <- function(s) {
    paste(toupper(substring(s, 1, 1)), substring(s, 2), sep = "")
}
mskcc_df$CancerType <- capFirst(mskcc_df$CancerType)
```

# survival analysis for pan-cancer and individual cancer types (Samstein et al. cohort)
```{r}
stratify_var = 'FGA' # AS or FGA
if (stratify_var == 'FGA'){
  stratifyVar_threshold = fga_threshold
}else if (stratify_var == 'AS'){
  stratifyVar_threshold = aneuploidy_threshold 
}else if (stratify_var == 'TMB'){
  stratifyVar_threshold = TMB_threshold 
}
if (stratify_var == 'TMB'){
  data_plot = mskcc_df
}else{
  data_plot = mskcc_df[mskcc_df$TMB_score=='low',]
}
data_plot[[paste0(stratify_var,'_score')]] <- relevel(factor(data_plot[[paste0(stratify_var,'_score')]]), ref = "low")
cancerType_list = sort(unique(mskcc_df['CancerType'])$CancerType)
##### OS
cancerData=data.frame(data_plot[paste0(stratify_var,'_score')],data_plot$OS_Months,data_plot$OS_Event)
colnames(cancerData) = c("Score", "OS_Months", "OS_Event")
sfit = survfit(Surv(data_plot$OS_Months,data_plot$OS_Event) ~ Score, data=cancerData)
scox = coxph(Surv(data_plot$OS_Months,data_plot$OS_Event)~Score, data=cancerData)
scox_coef = summary(scox)$coefficients
HR_value = scox_coef[2]
Z_value=scox_coef[4]
P_value=scox_coef[5]
HR_CI = exp(confint(scox))
print(paste(c('OS', 'Samstein et al. cohort Pan-Cancer', round(P_value,5), round(HR_value,2)), collapse= " "))
##### plot
fontSize = 13
survp=ggsurvplot(
  sfit,
  data = cancerData,
  size = 1, 
  palette =
    c("#E7B800", "#2E9FDF"),
  conf.int = TRUE,
  pval = FALSE, 
  xlim = c(0,80),
  ylim=c(0,1),
  xlab = "Time in months",
  break.time.by = 10,
  risk.table=TRUE,
  risk.table.height = 0.29,
  risk.table.pos="out",
  risk.table.col="black",
  risk.table.y.text = FALSE,
  tables.y.text = FALSE, 
  tables.theme = theme_cleantable(),
  legend.labs =c(paste0(stratify_var," low"), paste0(stratify_var," high")), 
  legend.title="",
  legend = c(0.6, 0.9),
  font.main = c(fontSize),
  font.caption = c(fontSize),
  font.legend = c(fontSize),
  font.tickslab = c(fontSize),
  font.x = c(fontSize),
  font.y = c(fontSize),
)+
  guides(colour = guide_legend(nrow = 1))
survp$plot = survp$plot+ 
              ggplot2::annotate("text", x=0, y=0.2, label=paste0('p',' = ', round(P_value,5), '\n', 'HR',' = ',round(HR_value,2),' (', round(HR_CI[1],2),'-',round(HR_CI[2],2),')'),size = 5,hjust = 0)

cn_now = paste0('TMBL_', stratify_var,stratifyVar_threshold)
title_str = paste0('Samstein_PanCancer_OS_',cn_now)
pdf(paste(main_fig_dir,title_str,".pdf",sep = ""),width=4, height=3)
print(survp, newpage = FALSE)
dev.off()

for (ct in cancerType_list){
  data_temp = data_plot[data_plot$CancerType==ct,]
  cancerData=data.frame(data_temp[paste0(stratify_var,'_score')],data_temp$OS_Months,data_temp$OS_Event)
  colnames(cancerData) = c("Score", "OS_Months", "OS_Event")
  sfit = survfit(Surv(data_temp$OS_Months,data_temp$OS_Event) ~ Score, data=cancerData)
  scox = coxph(Surv(data_temp$OS_Months,data_temp$OS_Event)~Score, data=cancerData)
  scox_coef = summary(scox)$coefficients
  HR_value = scox_coef[2] 
  Z_value=scox_coef[4]
  P_value=scox_coef[5]
  HR_CI = exp(confint(scox))
  print(paste(c('OS', 'Samstein et al. cohort ', ct, round(P_value,5), round(HR_value,2)), collapse= " "))
  ##### plot
  fontSize = 13
  survp=ggsurvplot(
    sfit,
    data = cancerData,
    size = 1, 
    palette =
      c("#E7B800", "#2E9FDF"),
    conf.int = TRUE, 
    pval = FALSE, 
    xlim = c(0,80),
    ylim=c(0,1),
    xlab = "Time in months",
    break.time.by = 10,
    risk.table=TRUE,
    risk.table.height = 0.29, 
    risk.table.pos="out",
    risk.table.col="black",
    risk.table.y.text = FALSE,
    tables.y.text = FALSE, 
    tables.theme = theme_cleantable(),
    legend.labs =c(paste0(stratify_var," low"), paste0(stratify_var," high")), 
    legend.title="",
    legend = c(2.65, 0.9),
    font.main = c(fontSize),
    font.caption = c(fontSize),
    font.legend = c(fontSize),
    font.tickslab = c(fontSize),
    font.x = c(fontSize),
    font.y = c(fontSize),
  )+ 
    guides(colour = guide_legend(nrow = 1))
  survp$plot = survp$plot+ 
              ggplot2::annotate("text", x=0, y=0.2, label=paste0('p',' = ',round(P_value,3), '\n', 'HR',' = ',round(HR_value,2),' (', round(HR_CI[1],2),'-',round(HR_CI[2],2),')'),size = 5, hjust = 0)
  title_str = paste0('Samstein_',ct,'_OS_',cn_now)
  pdf(paste(main_fig_dir,title_str,".pdf",sep = ""),width=4, height=3)
  print(survp, newpage = FALSE)
  dev.off()
}
```

# Multivariable hazard ratio Forest plot
```{r}
data_for_HR = mskcc_df
data_for_HR$TMB_score <- relevel(factor(data_for_HR$TMB_score), ref = "low")
data_for_HR$FGA_score <- relevel(factor(data_for_HR$FGA_score), ref = "low")
HR_each_cancer = data.frame()
model = coxph(Surv(OS_Months, OS_Event) ~ `TMB_score` + `FGA_score` + `Drug_class`, data = data_for_HR) 
HR_ct = exp(model$coefficients[['FGA_scorehigh']])
HR_ct_025 = exp(confint(model))['FGA_scorehigh',1]
HR_ct_975 = exp(confint(model))['FGA_scorehigh',2]
p_ct = summary(model)$coefficients['FGA_scorehigh',5]
HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = 'All'))
for (ct in cancerType_list){
  model = coxph(Surv(OS_Months, OS_Event) ~ `TMB` + `FGA_score` + `Drug_class`, data = data_for_HR[data_for_HR$CancerType==ct,]) 
  HR_ct = exp(model$coefficients[['FGA_scorehigh']])
  HR_ct_025 = exp(confint(model))['FGA_scorehigh',1]
  HR_ct_975 = exp(confint(model))['FGA_scorehigh',2]
  p_ct = summary(model)$coefficients['FGA_scorehigh',5]
  HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = ct))
}
colnames(HR_each_cancer) = c('HR_FGA','HR_FGA025','HR_FGA975','p-val')
HR_each_cancer['CANCER_TYPE'] = rownames(HR_each_cancer)

ggplot(HR_each_cancer, aes(x = HR_each_cancer[['HR_FGA']], y = HR_each_cancer[['CANCER_TYPE']])) +
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = HR_each_cancer[['HR_FGA025']], xmax = HR_each_cancer[['HR_FGA975']]))+
  theme(legend.position = "none") +
  geom_vline(xintercept=1,linetype=3)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black")) + 
  labs(x = "", y = "")+
  coord_trans(x="log2") +
  scale_x_continuous(breaks = c(0.1,0.5,1,5), labels=c('0.1',"0.5","1","5"), limits = c(0.1, 5))
ggsave(paste0(main_fig_dir,paste0("Samstein_Forest_FGA",fga_threshold,"_binary.pdf")), width = 3, height = 2.1)


data_for_HR = mskcc_df
data_for_HR$TMB_score <- relevel(factor(data_for_HR$TMB_score), ref = "low")
data_for_HR$AS_score <- relevel(factor(data_for_HR$AS_score), ref = "low")
HR_each_cancer = data.frame()
model = coxph(Surv(OS_Months, OS_Event) ~ `TMB_score` + `AS_score` + `Drug_class`, data = data_for_HR) 
HR_ct = exp(model$coefficients[['AS_scorehigh']])
HR_ct_025 = exp(confint(model))['AS_scorehigh',1]
HR_ct_975 = exp(confint(model))['AS_scorehigh',2]
p_ct = summary(model)$coefficients['AS_scorehigh',5]
HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = 'All'))
for (ct in cancerType_list){
  model = coxph(Surv(OS_Months, OS_Event) ~ `TMB` + `AS_score` + `Drug_class`, data = data_for_HR[data_for_HR$CancerType==ct,]) 
  HR_ct = exp(model$coefficients[['AS_scorehigh']])
  HR_ct_025 = exp(confint(model))['AS_scorehigh',1]
  HR_ct_975 = exp(confint(model))['AS_scorehigh',2]
  p_ct = summary(model)$coefficients['AS_scorehigh',5]
  HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = ct))
}
colnames(HR_each_cancer) = c('HR_AS','HR_AS025','HR_AS975','p-val')
HR_each_cancer['CANCER_TYPE'] = rownames(HR_each_cancer)

ggplot(HR_each_cancer, aes(x = HR_each_cancer[['HR_AS']], y = HR_each_cancer[['CANCER_TYPE']])) + # rep(9:1)
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = HR_each_cancer[['HR_AS025']], xmax = HR_each_cancer[['HR_AS975']]))+
  theme(legend.position = "none") +
  geom_vline(xintercept=1,linetype=3)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black")) + 
  labs(x = "", y = "")+
  coord_trans(x="log2") +
  scale_x_continuous(breaks = c(0.1,0.5,1,5), labels=c('0.1',"0.5","1","5"), limits = c(0.1, 5))
ggsave(paste0(main_fig_dir,paste0("Samstein_Forest_AS",aneuploidy_threshold,"_binary.pdf")), width = 3, height = 2.1)
```

# Univariable hazard ratio (in low-TMB patients) Forest plot
```{r}
data_for_HR = mskcc_df[mskcc_df$TMB_score=='low',]
data_for_HR$FGA_score <- relevel(factor(data_for_HR$FGA_score), ref = "low")
HR_each_cancer = data.frame()
model = coxph(Surv(OS_Months, OS_Event) ~ `FGA_score`, data = data_for_HR) 
HR_ct = exp(model$coefficients[['FGA_scorehigh']])
HR_ct_025 = exp(confint(model))['FGA_scorehigh',1]
HR_ct_975 = exp(confint(model))['FGA_scorehigh',2]
p_ct = summary(model)$coefficients['FGA_scorehigh',5]
HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = 'All'))
for (ct in cancerType_list){
  model = coxph(Surv(OS_Months, OS_Event) ~ `FGA_score`, data = data_for_HR[data_for_HR$CancerType==ct,]) 
  HR_ct = exp(model$coefficients[['FGA_scorehigh']])
  HR_ct_025 = exp(confint(model))['FGA_scorehigh',1]
  HR_ct_975 = exp(confint(model))['FGA_scorehigh',2]
  p_ct = summary(model)$coefficients['FGA_scorehigh',5]
  HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = ct))
}
colnames(HR_each_cancer) = c('HR_FGA','HR_FGA025','HR_FGA975','p-val')
HR_each_cancer['CANCER_TYPE'] = rownames(HR_each_cancer)

ggplot(HR_each_cancer, aes(x = HR_each_cancer[['HR_FGA']], y = HR_each_cancer[['CANCER_TYPE']])) +
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = HR_each_cancer[['HR_FGA025']], xmax = HR_each_cancer[['HR_FGA975']]))+
  theme(legend.position = "none") +
  geom_vline(xintercept=1,linetype=3)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black")) + 
  labs(x = "", y = "")+
  coord_trans(x="log2") +
  scale_x_continuous(breaks = c(0.1,0.5,1,5), labels=c('0.1',"0.5","1","5"), limits = c(0.1, 7))
ggsave(paste0(main_fig_dir,paste0("Samstein_Forest_univariate_FGA",fga_threshold,"_binary.pdf")), width = 3, height = 2.1)


data_for_HR = mskcc_df[mskcc_df$TMB_score=='low',]
data_for_HR$AS_score <- relevel(factor(data_for_HR$AS_score), ref = "low")
HR_each_cancer = data.frame()
model = coxph(Surv(OS_Months, OS_Event) ~ `AS_score`, data = data_for_HR) 
HR_ct = exp(model$coefficients[['AS_scorehigh']])
HR_ct_025 = exp(confint(model))['AS_scorehigh',1]
HR_ct_975 = exp(confint(model))['AS_scorehigh',2]
p_ct = summary(model)$coefficients['AS_scorehigh',5]
HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = 'All'))
for (ct in cancerType_list){
  model = coxph(Surv(OS_Months, OS_Event) ~ `AS_score`, data = data_for_HR[data_for_HR$CancerType==ct,]) 
  HR_ct = exp(model$coefficients[['AS_scorehigh']])
  HR_ct_025 = exp(confint(model))['AS_scorehigh',1]
  HR_ct_975 = exp(confint(model))['AS_scorehigh',2]
  p_ct = summary(model)$coefficients['AS_scorehigh',5]
  HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = ct))
}
colnames(HR_each_cancer) = c('HR_AS','HR_AS025','HR_AS975','p-val')
HR_each_cancer['CANCER_TYPE'] = rownames(HR_each_cancer)

ggplot(HR_each_cancer, aes(x = HR_each_cancer[['HR_AS']], y = HR_each_cancer[['CANCER_TYPE']])) + 
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = HR_each_cancer[['HR_AS025']], xmax = HR_each_cancer[['HR_AS975']]))+
  theme(legend.position = "none") +
  geom_vline(xintercept=1,linetype=3)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black")) + 
  labs(x = "", y = "")+
  coord_trans(x="log2") +
  scale_x_continuous(breaks = c(0.1,0.5,1,5), labels=c('0.1',"0.5","1","5"), limits = c(0.1, 7))
ggsave(paste0(main_fig_dir,paste0("Samstein_Forest_univariate_AS",aneuploidy_threshold,"_binary.pdf")), width = 3, height = 2.1)
```









# load data (Chowell et al cohort)
```{r}
features = c('TMB', 'FCNA', 'Cancer_type_grouped_2','Drug_class', 'OS_Event', 'OS_Months') 
data_train = read_excel("41587_2021_1070_MOESM3_ESM.xlsx", sheet = 'Training')
data_test = read_excel("41587_2021_1070_MOESM3_ESM.xlsx", sheet = 'Test')
data_all = rbind(data_train, data_test)
data_all = data_all[features]
colnames(data_all) = c('TMB', 'FGA', 'CancerType','Drug_class', 'OS_Event', 'OS_Months') 

data_all = data_all %>% mutate(across('CancerType', str_replace, 'Bladder', 'Bladder cancer'),
                   across('CancerType', str_replace, 'Breast', 'Breast cancer'),
                   across('CancerType', str_replace, 'Colorectal', 'Colorectal cancer'),
                   across('CancerType', str_replace, 'Esophageal', 'Esophagogastric cancer'),
                   across('CancerType', str_replace, 'Gastric', 'Esophagogastric cancer'),
                   across('CancerType', str_replace, 'Head & Neck', 'Head and neck cancer'),
                   across('CancerType', str_replace, 'Melanoma', 'Melanoma'),
                   across('CancerType', str_replace, 'NSCLC', 'Non-small cell lung cancer'),
                   across('CancerType', str_replace, 'Renal', 'Renal cell carcinoma'))
data_all = data_all[data_all$CancerType %in% cancerType_list,]

data_all = data_all %>% group_by(CancerType) %>% mutate(
         fga_bin = ifelse(FGA >= quantile(FGA, 0.5), "high", "low"),
         tmb_bin = ifelse(TMB >= quantile(TMB, 0.8), "high", "low"))

colnames(data_all) = c('TMB','FGA','CancerType','Drug_class','OS_Event','OS_Months', 'FGA_score', 'TMB_score')

```

# Overall survival (Chowell cohort)
```{r}
stratify_var = 'FGA'  # AS, FGA
stratifyVar_threshold = 0.2
if (stratify_var == 'TMB'){
  data_plot = data_all
}else{
  data_plot = data_all[data_all$TMB_score=='low',]
}

data_plot[[paste0(stratify_var,'_score')]] <- relevel(factor(data_plot[[paste0(stratify_var,'_score')]]), ref = "low")
cancerType_list = sort(unique(data_all['CancerType'])$CancerType)
##### OS
cancerData=data.frame(data_plot[paste0(stratify_var,'_score')],data_plot$OS_Months,data_plot$OS_Event)
colnames(cancerData) = c("Score", "OS_Months", "OS_Event")
sfit = survfit(Surv(data_plot$OS_Months,data_plot$OS_Event) ~ Score, data=cancerData)
scox = coxph(Surv(data_plot$OS_Months,data_plot$OS_Event)~Score, data=cancerData)
scox_coef = summary(scox)$coefficients
HR_value = scox_coef[2]
Z_value=scox_coef[4]
P_value=scox_coef[5]
HR_CI = exp(confint(scox))
print(paste(c('OS', 'Chowell et al. cohort Pan-Cancer', round(P_value,5), round(HR_value,2)), collapse= " "))
##### plot
fontSize = 13
survp=ggsurvplot(
  sfit,
  data = cancerData,
  size = 1, 
  palette =
    c("#E7B800", "#2E9FDF"),
  conf.int = TRUE,
  pval = FALSE, 
  xlim = c(0,80),
  ylim=c(0,1),
  xlab = "Time in months",
  break.time.by = 10,
  risk.table=TRUE,
  risk.table.height = 0.29, 
  risk.table.pos="out",
  risk.table.col="black",
  risk.table.y.text = FALSE,
  tables.y.text = FALSE, 
  tables.theme = theme_cleantable(),
  legend.labs =c(paste0(stratify_var," low"), paste0(stratify_var," high")), 
  legend.title="",
  legend = c(0.6, 0.9), 
  font.main = c(fontSize),
  font.caption = c(fontSize),
  font.legend = c(fontSize),
  font.tickslab = c(fontSize),
  font.x = c(fontSize),
  font.y = c(fontSize),
)+
  guides(colour = guide_legend(nrow = 1)) 
survp$plot = survp$plot+ 
              ggplot2::annotate("text", x=0, y=0.2, label=paste0('p',' = ',round(P_value,5), '\n', 'HR',' = ',round(HR_value,2),' (', round(HR_CI[1],2),'-',round(HR_CI[2],2),')'),size = 5,hjust = 0)

cn_now = paste0('TMBL_', stratify_var,stratifyVar_threshold)
title_str = paste0('Chowell_PanCancer_OS_',cn_now)
pdf(paste(main_fig_dir,title_str,".pdf",sep = ""),width=4, height=3)
print(survp, newpage = FALSE)
dev.off()

for (ct in cancerType_list){
  data_temp = data_plot[data_plot$CancerType==ct,]
  cancerData=data.frame(data_temp[paste0(stratify_var,'_score')],data_temp$OS_Months,data_temp$OS_Event)
  colnames(cancerData) = c("Score", "OS_Months", "OS_Event")
  sfit = survfit(Surv(data_temp$OS_Months,data_temp$OS_Event) ~ Score, data=cancerData)
  scox = coxph(Surv(data_temp$OS_Months,data_temp$OS_Event)~Score, data=cancerData)
  scox_coef = summary(scox)$coefficients
  HR_value = scox_coef[2] 
  Z_value=scox_coef[4]
  P_value=scox_coef[5]
  HR_CI = exp(confint(scox))
  print(paste(c('OS', 'Chowell et al. cohort ', ct, round(P_value,5), round(HR_value,2)), collapse= " "))
  ##### plot
  fontSize = 13
  survp=ggsurvplot(
    sfit,
    data = cancerData,
    size = 1,
    palette =
      c("#E7B800", "#2E9FDF"),
    conf.int = TRUE, 
    pval = FALSE,  
    xlim = c(0,80),
    ylim=c(0,1),
    xlab = "Time in months",
    break.time.by = 10,
    risk.table=TRUE,
    risk.table.height = 0.29, 
    risk.table.pos="out",
    risk.table.col="black",
    risk.table.y.text = FALSE,
    tables.y.text = FALSE, 
    tables.theme = theme_cleantable(),
    legend.labs =c(paste0(stratify_var," low"), paste0(stratify_var," high")), 
    legend.title="",
    legend = c(2.65, 0.9),
    font.main = c(fontSize),
    font.caption = c(fontSize),
    font.legend = c(fontSize),
    font.tickslab = c(fontSize),
    font.x = c(fontSize),
    font.y = c(fontSize),
  )+ 
    guides(colour = guide_legend(nrow = 1)) 
  survp$plot = survp$plot+ 
              ggplot2::annotate("text", x=0, y=0.2, label=paste0('p',' = ',round(P_value,3), '\n', 'HR',' = ',round(HR_value,2),' (', round(HR_CI[1],2),'-',round(HR_CI[2],2),')'),size = 5, hjust = 0)
  title_str = paste0('Chowell_',ct,'_OS_',cn_now)
  pdf(paste(main_fig_dir,title_str,".pdf",sep = ""),width=4, height=3)
  print(survp, newpage = FALSE)
  dev.off()
}
```

# Multivariable hazard ratio Forest plot
```{r}
data_for_HR = data_all
data_for_HR$TMB_score <- relevel(factor(data_for_HR$TMB_score), ref = "low")
data_for_HR$FGA_score <- relevel(factor(data_for_HR$FGA_score), ref = "low")

HR_each_cancer = data.frame()
model = coxph(Surv(OS_Months, OS_Event) ~ `TMB_score` + `FGA_score` + `Drug_class`, data = data_for_HR) 
HR_ct = exp(model$coefficients[['FGA_scorehigh']])
HR_ct_025 = exp(confint(model))['FGA_scorehigh',1]
HR_ct_975 = exp(confint(model))['FGA_scorehigh',2]
p_ct = summary(model)$coefficients['FGA_scorehigh',5]
HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = 'All'))
for (ct in cancerType_list){
  model = coxph(Surv(OS_Months, OS_Event) ~ `TMB` + `FGA_score` + `Drug_class`, data = data_for_HR[data_for_HR$CancerType==ct,]) 
  HR_ct = exp(model$coefficients[['FGA_scorehigh']])
  HR_ct_025 = exp(confint(model))['FGA_scorehigh',1]
  HR_ct_975 = exp(confint(model))['FGA_scorehigh',2]
  p_ct = summary(model)$coefficients['FGA_scorehigh',5]
  HR_each_cancer = rbind(HR_each_cancer,data.frame(HR_ct,HR_ct_025,HR_ct_975,p_ct,row.names = ct))
}
colnames(HR_each_cancer) = c('HR_FGA','HR_FGA025','HR_FGA975','p-val')
HR_each_cancer['CANCER_TYPE'] = rownames(HR_each_cancer)

ggplot(HR_each_cancer, aes(x = HR_each_cancer[['HR_FGA']], y = HR_each_cancer[['CANCER_TYPE']])) + # rep(9:1)
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = HR_each_cancer[['HR_FGA025']], xmax = HR_each_cancer[['HR_FGA975']]))+
  theme(legend.position = "none") +
  geom_vline(xintercept=1,linetype=3)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black")) + 
  labs(x = "", y = "")+
  coord_trans(x="log2") +
  scale_x_continuous(breaks = c(0.1,0.5,1,5), labels=c('0.1',"0.5","1","5"), limits = c(0.1, 5))
ggsave(paste0(main_fig_dir,paste0("Chowell_Forest_FGA0.2_binary.pdf")), width = 3, height = 2.1)

```

